parameters:
  - name: service_connection
  - name: resource_group_name
  - name: workspace_name
  - name: service_name
  - name: deployment_config
  - name: compute_type
    values:
      - aci
      - aks
  - name: compute_target
    default: "''"

jobs:
  - job: deploy_model
    displayName: ${{ upper( parameters.compute_type ) }} Deployment

    variables:
      - template: ../variables.yml
      # - name: service_name
      #   value: ${{ parameters.service_name }}
      # - name: compute_type
      #   value: ${{ parameters.compute_type }}
      # - name: deployment_config
      #   value: ${{ parameters.deployment_config }}
      # - name: compute_target
      #   value: ${{ parameters.compute_target }}

    steps:
      - task: AzureCLI@2
        displayName: Install azure-cli-ml
        inputs:
          azureSubscription: $(service_connection)
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: az extension add -n azure-cli-ml

      - task: DownloadBuildArtifacts@0
        displayName: Download model metadata artifact
        inputs:
          artifactName: $(model_artifact_name)

      - task: AzureCLI@2
        displayName: Deploy to ${{ upper( parameters.compute_type ) }}
        inputs:
          scriptType: bash
          azureSubscription: $(service_connection)
          scriptLocation: inlineScript
          inlineScript: |
            az ml model deploy \
            --name ${{ parameters.service_name }} \
            --compute-type $(compute_type) \
            --deploy-config-file $(deployment_config) \
            --inference-config-file $(inference_config) \
            --model-metadata-file $(model_metadata_file_path) \
            --compute-target $(compute_target) \
            --workspace-name $(workspace_name) \
            --resource-group $(resource_group_name) \
            --overwrite
